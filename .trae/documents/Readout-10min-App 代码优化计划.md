# Readout-10min-App 代码优化计划

## 1. 问题分析

当前代码存在以下问题：
- 文件结构不够清晰，缺乏明确的分层架构
- App.tsx 中包含了太多业务逻辑，包括文件解析、数据库操作等
- 文件解析逻辑重复，缺乏统一的解析接口
- 缺乏统一的类型定义
- 错误处理机制不够完善
- 代码复用性差

## 2. 优化目标

- 建立清晰的分层架构，实现页面、接口、业务的解耦
- 重构文件解析逻辑，支持多种文件类型的统一解析
- 优化文件上传流程，提高可靠性和性能
- 实现更好的错误处理和类型安全
- 提高代码的可维护性和可扩展性

## 3. 实现方案

### 3.1 文件结构优化

重新组织 web/src 目录结构：

```
web/src/
├── components/          # UI组件
│   ├── FileItem.tsx
│   ├── FileList.tsx
│   ├── FileUpload.tsx
│   └── Navbar.tsx
├── types/              # 类型定义
│   └── index.ts
├── services/           # 业务逻辑和API调用
│   ├── fileService.ts  # 文件上传和存储
│   ├── parseService.ts # 文件解析
│   └── contentService.ts # 内容管理
├── utils/              # 工具函数
│   ├── supabase.ts
│   └── helpers.ts
├── hooks/              # 自定义Hooks
│   └── useFiles.ts
├── App.css
├── App.tsx
├── index.css
└── main.tsx
```

### 3.2 核心功能重构

#### 3.2.1 类型定义 (types/index.ts)
- 定义统一的文件类型接口
- 定义解析结果类型
- 定义API响应类型

#### 3.2.2 文件解析服务 (services/parseService.ts)
- 实现统一的解析接口
- 针对不同文件类型实现专门的解析器：
  - PDF解析器
  - Word解析器
  - TXT解析器
- 实现段落拆分算法

#### 3.2.3 文件服务 (services/fileService.ts)
- 文件上传逻辑
- 文件存储管理
- 文件下载逻辑

#### 3.2.4 内容服务 (services/contentService.ts)
- 数据库操作封装
- 内容管理逻辑
- 统计信息计算

#### 3.2.5 自定义Hooks (hooks/useFiles.ts)
- 文件列表管理
- 文件上传状态管理
- 文件删除逻辑

### 3.3 页面组件优化

#### 3.3.1 App.tsx
- 简化主组件，只负责布局和状态管理
- 使用自定义Hooks管理文件状态
- 实现更好的错误处理

#### 3.3.2 FileUpload.tsx
- 简化上传组件，只负责UI交互
- 调用文件服务处理上传逻辑
- 实现更好的进度显示

#### 3.3.3 FileList.tsx
- 简化列表组件，只负责文件展示
- 调用内容服务处理文件操作

### 3.4 错误处理优化

- 实现统一的错误处理机制
- 针对不同错误类型显示不同的提示信息
- 实现更好的日志记录

## 4. 技术要点

- 使用 TypeScript 实现类型安全
- 采用分层架构实现解耦
- 使用策略模式实现不同文件类型的解析
- 实现更好的异步处理和错误捕获
- 优化数据库操作和文件存储

## 5. 实现步骤

1. 创建新的文件结构和类型定义
2. 实现文件解析服务
3. 实现文件服务和内容服务
4. 实现自定义Hooks
5. 优化页面组件
6. 测试和调试

## 6. 预期效果

- 代码结构更加清晰，易于维护和扩展
- 业务逻辑解耦，提高代码复用性
- 更好的类型安全和错误处理
- 优化的文件解析逻辑，提高解析成功率
- 更好的用户体验，包括上传进度显示和错误提示

## 7. 风险评估

- 代码重构可能引入新的bug，需要充分测试
- 依赖库的更新可能导致兼容性问题
- 文件解析逻辑的修改可能影响现有功能

## 8. 应对措施

- 采用渐进式重构，逐步替换原有功能
- 充分测试，包括单元测试和集成测试
- 保持良好的版本控制，便于回滚
- 实现详细的日志记录，便于调试

## 9. 交付标准

- 代码结构清晰，符合分层架构设计
- 所有功能正常工作，包括文件上传、解析、存储和管理
- 实现更好的用户体验和错误处理
- 代码可维护性和可扩展性提高
- 测试覆盖率达到70%以上